<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>اخبار | Gohartaj School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="همه اخبار رسمی مدرسه گوهرتاج">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="../imgs/profile/admin-121.png" alt="لوگو" class="brand-logo">
        <span class="brand-name">Gohartaj School</span>
      </div>
      <nav class="top-nav">
        <a href="/" class="nav-link">خانه</a>
        <a href="/news" class="nav-link active">اخبار</a>
        <a href="/news/live" class="nav-link">خبر زنده</a>
        <a href="/login/" class="nav-btn">ورود</a>
      </nav>
    </div>
    <div class="gradient-band"></div>
  </header>

  <main class="container app-container">
    <section class="card">
      <div class="panel-head">
        <h3>همه اخبار</h3>
        <div class="info-line">
          <span class="label">مرتب‌سازی:</span>
          <div class="btn-group">
            <button class="btn btn-soft" id="sort-newest">جدیدترین</button>
            <button class="btn btn-soft" id="sort-oldest">قدیمی‌ترین</button>
          </div>
        </div>
      </div>

      <div class="search-box mt-12">
        <input id="news-search" type="text" placeholder="جست‌وجو در عنوان و متن خبر">
        <button class="btn btn-outline" id="news-search-btn">جست‌وجو</button>
      </div>

      <div id="news-list" class="news-grid mt-12"></div>
      <div class="pagination mt-12" id="pager"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner footer-cols">
      <div class="footer-copy">© 2025 Gohartaj School — طراحی توسط Ehsan Programming Group</div>
      <div><a href="/login/" class="footer-login-btn">ورود به داشبورد</a></div>
    </div>
  </footer>

  <script src="../assets/js/data.js"></script>
  <script src="../assets/js/common.js"></script>
  <script>
    (async () => {
      const PAGE_SIZE = 6;
      let items = await Data.getNews();

      // normalize + default sort newest
      items = items.map(n => ({ ...n, _date: n.published_at ? new Date(n.published_at).getTime() : 0 }));
      items.sort((a, b) => b._date - a._date);

      const listEl = document.getElementById("news-list");
      const pagerEl = document.getElementById("pager");
      const qEl = document.getElementById("news-search");
      const qBtn = document.getElementById("news-search-btn");
      const sortNewest = document.getElementById("sort-newest");
      const sortOldest = document.getElementById("sort-oldest");

      let filtered = items.slice();
      let currentPage = 1;

      function renderPage(page = 1) {
        currentPage = page;
        const start = (page - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);
        listEl.innerHTML = pageItems.map(n => `
          <article class="card hover-soft">
            ${n.image_url ? `<div class="card-media">${imageOrNone(n.image_url, DefaultIcons.news, "news-image")}</div>` : ""}
            <div class="card-content">
              <h4 class="card-title">
                <a href="/news/item/?id=${n.id}" class="link-btn">${n.title}</a>
              </h4>
              <p class="card-body">${(n.body || "").slice(0, 180)}${(n.body || "").length > 180 ? "…" : ""}</p>
              <div class="card-meta">${formatDateFA(n.published_at || "")}${n.author ? " • " + n.author : ""}</div>
            </div>
          </article>
        `).join("") || "<p class='note'>خبری یافت نشد.</p>";

        // pager
        const pages = Math.ceil(filtered.length / PAGE_SIZE) || 1;
        pagerEl.innerHTML = Array.from({length: pages}, (_, i) => i + 1).map(p => `
          <a href="#" class="page-link ${p === currentPage ? 'text-strong border-strong' : ''}" data-page="${p}">${p}</a>
        `).join("");
        pagerEl.querySelectorAll(".page-link").forEach(a => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            const p = parseInt(a.getAttribute("data-page"), 10);
            renderPage(p);
          });
        });
      }

      function applySearch() {
        const q = (qEl.value || "").trim();
        if (!q) { filtered = items.slice(); renderPage(1); return; }
        const qa = q.toLowerCase();
        filtered = items.filter(n => (String(n.title || "").toLowerCase().includes(qa) || String(n.body || "").toLowerCase().includes(qa)));
        renderPage(1);
      }

      qBtn.addEventListener("click", applySearch);
      qEl.addEventListener("keydown", (e) => { if (e.key === "Enter") applySearch(); });

      sortNewest.addEventListener("click", () => { items.sort((a,b) => b._date - a._date); applySearch(); });
      sortOldest.addEventListener("click", () => { items.sort((a,b) => a._date - b._date); applySearch(); });

      renderPage(1);
    })();
  </script>
</body>
</html>