<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>ورود | Gohartaj School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- مسیر مطلق + نسخه برای حذف اثر کش قدیمی -->
  <link rel="stylesheet" href="/assets/css/style.css?v=login-2025-10-21-1">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="/imgs/profile/admin-121.png" alt="لوگو" class="brand-logo" onerror="this.outerHTML=DefaultIcons.logo;">
        <span class="brand-name">Gohartaj School</span>
      </div>
      <nav class="top-nav" id="top-nav">
        <!-- با اسکریپت پایین، اگر کاربر لاگین باشد، این بخش به «پنل» تبدیل می‌شود -->
        <a href="/" class="nav-link">خانه</a>
        <a href="/news" class="nav-link">اخبار</a>
        <a href="/news/live" class="nav-link">خبر زنده</a>
        <a href="/login/" class="nav-btn" id="nav-login-btn">ورود</a>
      </nav>
    </div>
    <div class="gradient-band"></div>
  </header>

  <main class="container app-container">
    <section class="login-section">
      <form id="login-form" class="card form-card">
        <h3>ورود به داشبورد</h3>
        <label>نام و نام خانوادگی
          <input type="text" name="full_name" required placeholder="مثلاً علی رضایی" autocomplete="name">
        </label>
        <label>کد ملی
          <input type="text" name="national_id" required placeholder="مثلاً 1111111111" inputmode="numeric" autocomplete="off">
        </label>
        <label>رمز عبور
          <input type="password" name="password" required placeholder="رمز عبور" autocomplete="current-password">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn">ورود</button>
        </div>
        <p id="login-error" class="error"></p>
      </form>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div>© 2025 Gohartaj School</div>
    </div>
  </footer>

  <!-- اسکریپت‌ها با مسیر مطلق و نسخه‌بندی -->
  <script src="/assets/js/common.js?v=login-2025-10-21-1" defer></script>
  <script src="/assets/js/data.js?v=login-2025-10-21-2" defer></script>

  <script>
    // ابزار پاک‌سازی متن هم‌راستا با app.js
    function cleanText(t) {
      return String(t || "")
        .replace(/\s*\n+\s*/g, " ")
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    // مدیریت وضعیت ناوبری بالا: اگر لاگین باشد، «پنل» نشان بده و به داشبورد هدایت کن
    function setupTopNav() {
      try {
        const btn = document.getElementById("nav-login-btn");
        const sessionRaw = localStorage.getItem("session");
        const session = sessionRaw ? JSON.parse(sessionRaw) : null;

        if (session && session.role) {
          // دکمه ورود را به پنل تبدیل کن
          btn.textContent = "پنل";
          btn.classList.add("nav-btn");
          btn.setAttribute("href", session.role === "admin" ? "/dash/admin/" : "/dash/student");

          // اگر کاربر وارد صفحه‌ی لاگین شده و لاگین است، بفرست داخل پنل
          const onLoginPage = location.pathname.replace(/\/+$/, "") === "/login";
          if (onLoginPage) {
            location.replace(session.role === "admin" ? "/dash/admin/" : "/dash/student");
          }
        } else {
          // کاربر لاگین نیست
          btn.textContent = "ورود";
          btn.setAttribute("href", "/login/");
        }
      } catch {}
    }

    // لاگین پایدار: استفاده از localStorage برای ماندگاری دائمی روی دستگاه
    async function setupLoginForm() {
      const form = document.getElementById("login-form");
      const err = document.getElementById("login-error");
      if (!form) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        err.textContent = "";

        const full_name = cleanText(form.full_name.value);
        const national_id = cleanText(form.national_id.value);
        const password = String(form.password.value);

        try {
          // داده‌ها را از مسیر مطلق می‌گیریم؛ data.js جدید همین کار را می‌کند
          const dataset = await Data.getStudents();

          const admin = (dataset.admins || []).find(u =>
            cleanText(u.full_name) === full_name &&
            cleanText(u.national_id) === national_id &&
            String(u.password) === password
          );

          if (admin) {
            localStorage.setItem("session", JSON.stringify({ role: "admin", user: admin }));
            // هدایت مستقیم و قطعی به پنل
            location.replace("/dash/admin/");
            return;
          }

          const student = (dataset.students || []).find(u =>
            cleanText(u.full_name) === full_name &&
            cleanText(u.national_id) === national_id &&
            String(u.password) === password
          );

          if (student) {
            localStorage.setItem("session", JSON.stringify({ role: "student", user: student }));
            location.replace("/dash/student");
            return;
          }

          err.textContent = "ورود ناموفق. اطلاعات را بررسی کنید.";
        } catch {
          err.textContent = "بارگذاری داده‌ها با خطا مواجه شد.";
        }
      });
    }

    // پاکسازی سرویس‌ورکر و کش‌های آن، فقط برای اطمینان اگر قبلاً فعال بوده
    (function resetSWCachesOnce() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())).catch(() => {});
      }
      if (window.caches && window.caches.keys) {
        caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))).catch(() => {});
      }
    })();

    // راه‌اندازی صفحه
    document.addEventListener("DOMContentLoaded", () => {
      setupTopNav();
      setupLoginForm();
    });

    // اگر از bfcache برگشت، وضعیت ناوبری را دوباره اعمال کن تا «پنل/ورود» صحیح باشد
    window.addEventListener("pageshow", (e) => {
      if (e.persisted) setupTopNav();
    });
  </script>
</body>
</html>